---
import Layout from "@/layouts/Layout.astro";
import { Breadcrumb } from "@/components/navigation/Breadcrumb";
import type { GroupDTO } from "@/types";
import ActivityFeedView from "@/components/groups/ActivityFeedView";

export const prerender = false;

const groupId = Astro.params.group_id!;
const supabase = Astro.locals.supabase;
const userId = Astro.locals.user?.id;

if (!groupId) {
  Astro.response.status = 400;
  throw new Error("group_id is required");
}

if (!supabase) {
  Astro.response.status = 500;
  throw new Error("Supabase client not available");
}

let groupDto: GroupDTO | null = null;

// Verify membership and fetch group details
const { data: membership } = await supabase
  .from("group_memberships")
  .select("user_id")
  .eq("group_id", groupId)
  .eq("user_id", userId!)
  .maybeSingle();

if (membership) {
  const { data: groupRow } = await supabase.from("groups").select("*").eq("id", groupId).maybeSingle();

  if (groupRow) {
    groupDto = {
      id: groupRow.id,
      name: groupRow.name,
      description: groupRow.description,
      lore_theme: groupRow.lore_theme,
      start_date: groupRow.start_date,
      end_date: groupRow.end_date,
      status: groupRow.status,
      invite_code: groupRow.invite_code,
      created_by: groupRow.created_by,
      created_at: groupRow.created_at,
      updated_at: groupRow.updated_at,
      deleted_at: groupRow.deleted_at,
    } as GroupDTO;
  }
}
---

<Layout title="Aktywność zespołu">
  <main class="min-h-screen w-full p-4 md:p-8">
    <div class="mx-auto w-full max-w-4xl">
      <Breadcrumb
        items={[
          { label: "Lista grup", href: "/groups" },
          { label: groupDto?.name || "Grupa", href: `/groups/${groupId}/dashboard` },
        ]}
      />
      <h1 class="mb-4 text-2xl font-semibold tracking-tight">Aktywność zespołu</h1>
      <!-- React container responsible for data fetching and realtime -->
      <div>
        <ActivityFeedView client:load groupId={groupId} />
      </div>
    </div>
  </main>
</Layout>
