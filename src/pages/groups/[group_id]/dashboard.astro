---
import Layout from "@/layouts/Layout.astro";
import type { GroupDashboardDTO, GroupPermissionsDTO, GroupStatus, GroupDTO } from "@/types";
import { ArchivedBanner } from "@/components/groups/ArchivedBanner";
import { GroupDashboardTiles } from "@/components/groups/GroupDashboardTiles";
import { GroupDashboardTilesClient } from "@/components/groups/GroupDashboardTilesClient";
import type { DashboardTilesVM } from "@/lib/dashboard/types";
import { mapDashboardToTilesVM } from "@/lib/mappers/dashboard-tiles.mapper";
import { DashboardShortcuts } from "@/components/groups/DashboardShortcuts";
import { QuickTaskForm } from "@/components/groups/QuickTaskForm";
import { RecentActivityFeed } from "@/components/groups/RecentActivityFeed";
import { Breadcrumb } from "@/components/navigation/Breadcrumb";
import { getDashboard } from "@/lib/services/dashboard.service";
import { getGroupPermissions } from "@/lib/services/permissions.service";
import { DashboardInviteCard } from "@/components/groups/DashboardInviteCard";
import { mapGroupRowToDTO } from "@/lib/mappers/group.mapper";

export const prerender = false;

const groupId = Astro.params.group_id!;
const supabase = Astro.locals.supabase;
const userId = Astro.locals.user?.id;

if (!groupId) {
  Astro.response.status = 400;
  throw new Error("group_id is required");
}

if (!supabase) {
  Astro.response.status = 500;
  throw new Error("Supabase client not available");
}

let dashboardDto: GroupDashboardDTO | null = null;
let permissionsDto: GroupPermissionsDTO | null = null;
let groupDto: GroupDTO | null = null;
let errorMessage: string | null = null;

// Call service functions directly instead of fetch (to preserve session)
const [dashboardResult, permissionsResult] = await Promise.all([
  getDashboard(supabase, groupId, userId),
  getGroupPermissions(supabase, groupId, userId!),
]);

// Handle dashboard result
if ("error" in dashboardResult) {
  Astro.response.status = 500;
  errorMessage = dashboardResult.error.message || "Nie udało się załadować danych z pulpitu.";
} else {
  dashboardDto = dashboardResult.data;
}

// Handle permissions result (non-fatal)
if ("data" in permissionsResult) {
  permissionsDto = permissionsResult.data;
}

// Fetch group details - verify membership
const { data: membership } = await supabase
  .from("group_memberships")
  .select("user_id")
  .eq("group_id", groupId)
  .eq("user_id", userId!)
  .maybeSingle();

if (!membership) {
  Astro.response.status = 404;
  errorMessage = "Group not found";
} else {
  // User is a member, fetch group
  const { data: groupRow } = await supabase.from("groups").select("*").eq("id", groupId).maybeSingle();

  if (groupRow) {
    groupDto = mapGroupRowToDTO(groupRow);
  }
}

// Optional: fetch group status for ArchivedBanner
let groupStatus: GroupStatus | undefined = undefined;
try {
  if (supabase && groupDto) {
    const { data } = await supabase.from("groups").select("status").eq("id", groupId).maybeSingle();
    groupStatus = (data?.status as GroupStatus) ?? undefined;
  }
} catch (e) {
  // non-fatal, ignore
}

const tilesVm: DashboardTilesVM | null = dashboardDto
  ? mapDashboardToTilesVM(dashboardDto, permissionsDto ?? undefined)
  : null;
---

<Layout title="Pulpit grupy">
  <main class="min-h-screen w-full p-4 md:p-8">
    <div class="mx-auto w-full max-w-6xl">
      <Breadcrumb items={[{ label: "Lista grup", href: "/groups" }]} />
      <h1 class="mb-4 text-2xl font-semibold tracking-tight">{groupDto?.name || "Pulpit grupy"}</h1>

      <ArchivedBanner status={groupStatus} />

      {
        errorMessage ? (
          <div
            role="alert"
            class="rounded-md border border-destructive/40 bg-destructive/10 text-destructive p-3 text-sm"
          >
            {errorMessage}
          </div>
        ) : null
      }

      {
        tilesVm ? (
          <GroupDashboardTilesClient client:load groupId={groupId} initialVm={tilesVm} permissions={permissionsDto} />
        ) : (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {Array.from({ length: 4 }).map((_, i) => (
              <div class="h-28 rounded-md bg-muted animate-pulse" key={i} />
            ))}
          </div>
        )
      }

      <DashboardShortcuts groupId={groupId} permissions={permissionsDto} />

      {
        groupDto && permissionsDto ? (
          <DashboardInviteCard
            client:load
            groupId={groupId}
            group={groupDto}
            canManage={permissionsDto.role === "admin"}
          />
        ) : null
      }

      {
        permissionsDto ? (
          <QuickTaskForm
            client:load
            groupId={groupId}
            canCreate={permissionsDto.role === "admin" || permissionsDto.role === "editor"}
            onCreated={() => {
              // Realtime/refetch will be added in the next iteration
            }}
          />
        ) : null
      }

      {dashboardDto ? <RecentActivityFeed groupId={groupId} initialItems={dashboardDto.recent_activity} /> : null}
    </div>
  </main>
</Layout>
