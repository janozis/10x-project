---
import Layout from "@/layouts/Layout.astro";
import type { CampDayDTO, GroupPermissionsDTO, GroupDTO } from "@/types";
import { CampDayView } from "@/components/camp-days/CampDayView";
import { Breadcrumb } from "@/components/navigation/Breadcrumb";
import { getGroupPermissions } from "@/lib/services/permissions.service";
import { getCampDay } from "@/lib/services/camp-days.service";

export const prerender = false;

const groupId = Astro.params.group_id!;
const campDayId = Astro.params.camp_day_id!;
const supabase = Astro.locals.supabase;
const userId = Astro.locals.user?.id;

if (!groupId || !campDayId) {
  Astro.response.status = 400;
  throw new Error("group_id and camp_day_id are required");
}

if (!supabase) {
  Astro.response.status = 500;
  throw new Error("Supabase client not available");
}

let campDayDto: CampDayDTO | null = null;
let permissionsDto: GroupPermissionsDTO | null = null;
let groupDto: GroupDTO | null = null;
let errorMessage: string | null = null;

// Call services directly instead of fetch
const [campDayResult, permissionsResult] = await Promise.all([
  getCampDay(supabase, userId, campDayId),
  getGroupPermissions(supabase, groupId, userId!),
]);

// Handle camp day result
if ("error" in campDayResult) {
  Astro.response.status = campDayResult.error.code === "NOT_FOUND" ? 404 : 500;
  errorMessage = campDayResult.error.message || "Nie udało się załadować danych dnia obozu.";
} else {
  campDayDto = campDayResult.data;
}

// Handle permissions result (non-fatal)
if ("data" in permissionsResult) {
  permissionsDto = permissionsResult.data;
}

// Fetch group details - verify membership
const { data: membership } = await supabase
  .from("group_memberships")
  .select("user_id")
  .eq("group_id", groupId)
  .eq("user_id", userId!)
  .maybeSingle();

if (membership) {
  // User is a member, fetch group
  const { data: groupRow } = await supabase
    .from("groups")
    .select("*")
    .eq("id", groupId)
    .maybeSingle();
  
  if (groupRow) {
    groupDto = {
      id: groupRow.id,
      name: groupRow.name,
      description: groupRow.description,
      lore_theme: groupRow.lore_theme,
      start_date: groupRow.start_date,
      end_date: groupRow.end_date,
      status: groupRow.status,
      invite_code: groupRow.invite_code,
      created_by: groupRow.created_by,
      created_at: groupRow.created_at,
      updated_at: groupRow.updated_at,
      deleted_at: groupRow.deleted_at,
    } as GroupDTO;
  }
}
---

<Layout title="Plan dnia">
  <main class="min-h-screen w-full p-4 md:p-8">
    <div class="mx-auto w-full max-w-5xl">
      <Breadcrumb items={[
        { label: "Lista grup", href: "/groups" },
        { label: groupDto?.name || "Grupa", href: `/groups/${groupId}/dashboard` },
        { label: "Dni obozu", href: `/groups/${groupId}/camp-days` }
      ]} />
      <h1 class="mb-4 text-2xl font-semibold tracking-tight">
        {campDayDto ? `Dzień ${campDayDto.day_number}: ${campDayDto.theme || 'Plan dnia'}` : 'Plan dnia'}
      </h1>

      {
        errorMessage ? (
          <div
            role="alert"
            class="rounded-md border border-destructive/40 bg-destructive/10 text-destructive p-3 text-sm"
          >
            {errorMessage}
          </div>
        ) : null
      }

      {
        campDayDto ? (
          <CampDayView
            client:load
            groupId={groupId}
            campDayId={campDayId}
            initialCampDay={campDayDto}
            permissions={permissionsDto}
          />
        ) : (
          <div class="space-y-3">
            <div class="h-9 w-full rounded-md bg-muted animate-pulse" />
            <div class="h-24 w-full rounded-md bg-muted animate-pulse" />
            <div class="h-32 w-full rounded-md bg-muted animate-pulse" />
          </div>
        )
      }
    </div>
  </main>
</Layout>
