---
import Layout from "@/layouts/Layout.astro";
import CampDayEditForm from "@/components/camp-days/CampDayEditForm";
import { Toaster } from "@/components/ui/sonner";
import type { CampDayDTO, GroupDTO, GroupPermissionsDTO } from "@/types";
import { Breadcrumb } from "@/components/navigation/Breadcrumb";
import { getCampDay } from "@/lib/services/camp-days.service";
import { getGroupPermissions } from "@/lib/services/permissions.service";

export const prerender = false;

const groupParam = Astro.params.group_id;
const campDayParam = Astro.params.camp_day_id;
const supabase = Astro.locals.supabase;
const userId = Astro.locals.user?.id;

if (!groupParam || !campDayParam) {
  Astro.response.status = 400;
  throw new Error("Parametry group_id i camp_day_id są wymagane");
}

if (!supabase) {
  Astro.response.status = 500;
  throw new Error("Supabase client not available");
}

const groupId = groupParam;
const campDayId = campDayParam;

let campDayDto: CampDayDTO | undefined;
let groupDto: GroupDTO | null = null;
let permissionsDto: GroupPermissionsDTO | null = null;
let etag: string | undefined;
let errorMessage: string | null = null;
let permissionsWarning: string | null = null;

// Call services directly instead of helper functions that use fetch
const [campDayResult, permissionsResult] = await Promise.all([
  getCampDay(supabase, userId, campDayId),
  getGroupPermissions(supabase, groupId, userId!),
]);

// Handle camp day result
if ("error" in campDayResult) {
  Astro.response.status = campDayResult.error.code === "NOT_FOUND" ? 404 : 500;
  errorMessage = campDayResult.error.message ?? "Nie udało się pobrać danych dnia obozowego.";
} else {
  campDayDto = campDayResult.data;
  // Note: etag is not available from direct service call
  // If needed, it should be added to the service response
}

// Handle permissions result
if ("error" in permissionsResult) {
  const code = permissionsResult.error.code;
  if (code === "NOT_FOUND") {
    Astro.response.status = 404;
    errorMessage = permissionsResult.error.message ?? "Nie znaleziono strony lub nie masz dostępu do tej grupy.";
    campDayDto = undefined;
  } else if (code === "UNAUTHORIZED") {
    Astro.response.status = 401;
    errorMessage = permissionsResult.error.message ?? "Musisz być zalogowany, aby edytować dzień obozowy.";
    campDayDto = undefined;
  } else {
    permissionsWarning = permissionsResult.error.message ?? "Nie udało się pobrać uprawnień użytkownika.";
  }
} else {
  permissionsDto = permissionsResult.data;
}

// Fetch group details - verify membership
const { data: membership } = await supabase
  .from("group_memberships")
  .select("user_id")
  .eq("group_id", groupId)
  .eq("user_id", userId!)
  .maybeSingle();

if (membership) {
  const { data: groupRow } = await supabase.from("groups").select("*").eq("id", groupId).maybeSingle();

  if (groupRow) {
    groupDto = {
      id: groupRow.id,
      name: groupRow.name,
      description: groupRow.description,
      lore_theme: groupRow.lore_theme,
      start_date: groupRow.start_date,
      end_date: groupRow.end_date,
      status: groupRow.status,
      invite_code: groupRow.invite_code,
      created_by: groupRow.created_by,
      created_at: groupRow.created_at,
      updated_at: groupRow.updated_at,
      deleted_at: groupRow.deleted_at,
    } as GroupDTO;
  }
}

const groupDateRange =
  groupDto?.start_date && groupDto?.end_date
    ? { startDate: groupDto.start_date, endDate: groupDto.end_date }
    : undefined;
---

<Layout title="Edycja dnia obozowego">
  <main class="min-h-screen w-full p-4 md:p-8">
    <div class="mx-auto w-full max-w-3xl space-y-6">
      <Breadcrumb
        items={[
          { label: "Lista grup", href: "/groups" },
          { label: groupDto?.name || "Grupa", href: `/groups/${groupId}/dashboard` },
          { label: "Dni obozu", href: `/groups/${groupId}/camp-days` },
        ]}
      />
      <header class="space-y-1">
        <h1 class="text-2xl font-semibold tracking-tight">Edytuj dzień obozowy</h1>
        <p class="text-sm text-muted-foreground">
          Zmień datę lub temat dnia. Zmiany są dostępne tylko dla administratorów.
        </p>
      </header>

      {
        errorMessage ? (
          <div
            role="alert"
            class="rounded-md border border-destructive/40 bg-destructive/10 p-3 text-sm text-destructive"
          >
            {errorMessage}
          </div>
        ) : null
      }

      {
        permissionsWarning ? (
          <div role="status" class="rounded-md border border-border/60 bg-muted/30 p-3 text-sm text-muted-foreground">
            {permissionsWarning}
          </div>
        ) : null
      }

      {
        campDayDto ? (
          <CampDayEditForm
            client:load
            groupId={groupId}
            campDay={campDayDto}
            permissions={permissionsDto ?? undefined}
            groupDateRange={groupDateRange}
            etag={etag}
          />
        ) : !errorMessage ? (
          <div class="space-y-3" aria-busy="true">
            <div class="h-9 w-full rounded-md bg-muted animate-pulse" />
            <div class="h-24 w-full rounded-md bg-muted animate-pulse" />
            <div class="h-32 w-full rounded-md bg-muted animate-pulse" />
          </div>
        ) : null
      }
    </div>
  </main>
  <Toaster client:load />
</Layout>
