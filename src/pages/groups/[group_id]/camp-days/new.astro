---
import Layout from "@/layouts/Layout.astro";
import CampDayCreateForm from "@/components/camp-days/CampDayCreateForm";
import { Toaster } from "@/components/ui/sonner";
import { Breadcrumb } from "@/components/navigation/Breadcrumb";
import type { ApiSingle, GroupDTO } from "@/types";

export const prerender = false;

const { group_id } = Astro.params;

if (!group_id) {
  Astro.response.status = 400;
  throw new Error("Parametr group_id jest wymagany");
}

const redirectParam = Astro.url.searchParams.get("redirect");
const redirectMode = redirectParam === "list" ? "list" : "detail";

// Fetch group details for breadcrumb
const groupUrl = new URL(`/api/groups/${group_id}`, Astro.url);
const groupRes = await fetch(groupUrl);

let groupDto: GroupDTO | null = null;
if (groupRes.ok) {
  const body = (await groupRes.json()) as ApiSingle<GroupDTO>;
  groupDto = body.data;
}
---

<Layout title="Nowy dzień obozu">
  <main class="min-h-screen w-full p-4 md:p-8">
    <div class="mx-auto w-full max-w-3xl space-y-6">
      <Breadcrumb items={[
        { label: "Lista grup", href: "/groups" },
        { label: groupDto?.name || "Grupa", href: `/groups/${group_id}/dashboard` },
        { label: "Dni obozu", href: `/groups/${group_id}/camp-days` }
      ]} />
      <header class="space-y-1">
        <h1 class="text-2xl font-semibold tracking-tight">Dodaj dzień obozowy</h1>
        <p class="text-sm text-muted-foreground">Wypełnij formularz, aby utworzyć nowy dzień w planie obozu.</p>
      </header>

      <CampDayCreateForm groupId={group_id} defaultRedirect={redirectMode} client:load />
    </div>
  </main>
  <Toaster client:load />
</Layout>

