---
import Layout from "@/layouts/Layout.astro";
import { ActivityEditorApp } from "@/components/activities/editor/ActivityEditorApp";
import { Toaster } from "@/components/ui/sonner";
import { Breadcrumb } from "@/components/navigation/Breadcrumb";
import type { ActivityDTO, GroupDTO, CampDayDTO } from "@/types";
import { getActivity } from "@/lib/services/activities.service";
import { getCampDay } from "@/lib/services/camp-days.service";

export const prerender = false;

const activityId = Astro.params.activity_id || "";
const supabase = Astro.locals.supabase;
const userId = Astro.locals.user?.id;

if (!activityId) {
  Astro.response.status = 400;
  throw new Error("activity_id is required");
}

if (!supabase) {
  Astro.response.status = 500;
  throw new Error("Supabase client not available");
}

// Check if we're coming from a camp day view
const urlParams = new URL(Astro.request.url).searchParams;
const fromCampDay = urlParams.get("from") === "camp-day";
const campDayId = urlParams.get("camp_day_id");

let activityDto: ActivityDTO | null = null;
let groupDto: GroupDTO | null = null;
let campDayDto: CampDayDTO | null = null;

// Call service directly instead of fetch to avoid session issues
const activityResult = await getActivity(supabase, userId, activityId);

if ("error" in activityResult) {
  console.log("[edit.astro] Activity service returned error:", activityResult.error);
} else {
  activityDto = activityResult.data as ActivityDTO;
  console.log("[edit.astro] Activity DTO loaded, group_id:", activityDto.group_id);

  // Fetch group details for breadcrumb
  if (activityDto?.group_id) {
    const { data: groupRow } = await supabase.from("groups").select("*").eq("id", activityDto.group_id).maybeSingle();

    if (groupRow) {
      groupDto = {
        id: groupRow.id,
        name: groupRow.name,
        description: groupRow.description,
        lore_theme: groupRow.lore_theme,
        start_date: groupRow.start_date,
        end_date: groupRow.end_date,
        status: groupRow.status,
        invite_code: groupRow.invite_code,
        created_by: groupRow.created_by,
        created_at: groupRow.created_at,
        updated_at: groupRow.updated_at,
        deleted_at: groupRow.deleted_at,
      } as GroupDTO;
      console.log("[edit.astro] Group DTO loaded:", groupDto.name);
    }

    // If coming from camp day, fetch camp day details
    if (fromCampDay && campDayId) {
      console.log("[edit.astro] Fetching camp day:", campDayId);
      const campDayResult = await getCampDay(supabase, userId, campDayId);

      if ("error" in campDayResult) {
        console.log("[edit.astro] Camp day service returned error:", campDayResult.error);
      } else {
        campDayDto = campDayResult.data;
        console.log("[edit.astro] Camp day DTO loaded:", campDayDto.day_number, campDayDto.theme);
      }
    }
  }
}

// Build breadcrumb items dynamically - always show at least "Lista grup"
const breadcrumbItems = activityDto?.group_id
  ? [
      { label: "Lista grup", href: "/groups" },
      { label: groupDto?.name || "Grupa", href: `/groups/${activityDto.group_id}/dashboard` },
      ...(fromCampDay && campDayDto
        ? [
            { label: "Dni obozu", href: `/groups/${activityDto.group_id}/camp-days` },
            {
              label: campDayDto.theme || `Dzień ${campDayDto.day_number}`,
              href: `/groups/${activityDto.group_id}/camp-days/${campDayDto.id}`,
            },
          ]
        : [{ label: "Aktywności", href: `/groups/${activityDto.group_id}/activities` }]),
    ]
  : [{ label: "Lista grup", href: "/groups" }];
---

<Layout title="Edytor aktywności">
  <main class="min-h-screen w-full p-4 md:p-8">
    <div class="mx-auto w-full max-w-5xl">
      <Breadcrumb items={breadcrumbItems} />
      <ActivityEditorApp client:load activityId={activityId} />
    </div>
  </main>
  <Toaster client:load />
</Layout>
